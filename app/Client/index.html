<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Mini-app portal</title>
    <script src="https://telegram.org/js/telegram-web-app.js"></script>
    <style>
        body { font-family: Arial, sans-serif; margin: 20px; }
        .tab { display: none; }
        .tab.active { display: block; }
        button { margin: 5px; padding: 10px; cursor: pointer; }
        table { width: 100%; border-collapse: collapse; margin-top: 10px; }
        th, td { border: 1px solid #ccc; padding: 8px; text-align: left; }
        #upload-form { margin-top: 10px; }
    </style>
</head>
<body>
    <h1>Mini-app portal</h1>
    <div>
        <button onclick="showTab('profile')">Profile</button>
        <button onclick="showTab('leaderboard')">Liderboard</button>
        <button onclick="showTab('upload')">Upload your work</button>
    </div>

    <div id="profile" class="tab active">
        <h2>Profile</h2>
        <div id="profile-info">Loading...</div>
    </div>

    <div id="leaderboard" class="tab">
        <h2>Liderboard</h2>
        <table>
            <thead>
                <tr><th>Name</th><th>Works submitted</th></tr>
            </thead>
            <tbody id="leaderboard-body"><tr><td colspan="2">Loading...</td></tr></tbody>
        </table>
    </div>

    <div id="upload" class="tab">
        <h2>Submit your work</h2>
        <form id="upload-form">
            <input type="file" name="file" accept="*/*" required /><br />
            <button type="submit">Send</button>
        </form>
        <div id="upload-result"></div>
    </div>
    <script src="https://telegram.org/js/telegram-web-app.js?57"></script>

    <script>
        const tg = Telegram.WebApp;
        tg.expand();
        const urlParams = new URLSearchParams(window.location.search);
        window.user_id = urlParams.get('user_id');

        // Если не нашли в URL, пробуем получить из Telegram
        if (!window.user_id && tg.initDataUnsafe && tg.initDataUnsafe.user) {
            window.user_id = tg.initDataUnsafe.user.id;
        }

        // Для отладки
        console.log("User ID:", window.user_id);
        console.log("Full initData:", tg.initData);
        console.log("Unsafe initData:", tg.initDataUnsafe);

        // Базовый URL API
        window.API_BASE = "http://52.87.161.100:8000/";
        window.user_id = "1212566690"
        function showTab(id) {
            document.querySelectorAll('.tab').forEach(el => el.classList.remove('active'));
            document.getElementById(id).classList.add('active');
            if (id === 'profile') loadProfile();
            if (id === 'leaderboard') loadLeaderboard();
        }

        async function loadProfile() {
            document.getElementById('profile-info').textContent = 'Loading...';
            try {
                // const res = await fetch(`${API_BASE}/users/telegram/${user_id}`);
                const res = await fetch(`${API_BASE}users/telegram/${user_id}`);
                if (!res.ok) throw new Error('Ошибка загрузки профиля');
                const data = await res.json();
                document.getElementById('profile-info').innerHTML =
                    `<p><strong>Name:</strong> ${data.first_name} ${data.last_name}</p>` +
                    `<p><strong>Email:</strong> ${data.email}</p>` +
                    `<p><strong>Role:</strong> ${data.role}</p>`;
            } catch (err) {
                console.error(err);
                document.getElementById('profile-info').textContent = `Не удалось загрузить профиль.${user_id} ${err}`;
            }
        }

        async function loadLeaderboard() {
            const tbody = document.getElementById('leaderboard-body');
            tbody.innerHTML = '<tr><td colspan="2">Loading...</td></tr>';
            try {
                const res = await fetch(`${API_BASE}/leaderboard`);
                if (!res.ok) throw new Error('Ошибка загрузки лидерборда');
                const list = await res.json();
                tbody.innerHTML = '';
                list.forEach(item => {
                    tbody.innerHTML += `<tr><td>${item.name}</td><td>${item.submissions}</td></tr>`;
                });
            } catch (err) {
                console.error(err);
                tbody.innerHTML = '<tr><td colspan="2">The data could not be uploaded.</td></tr>';
            }
        }

        document.getElementById('upload-form').addEventListener('submit', async e => {
            e.preventDefault();
            const resultEl = document.getElementById('upload-result');
            resultEl.textContent = 'Loading...';
            const formData = new FormData(e.target);
            formData.append('user_id', user_id);
            try {
                const res = await fetch(`${API_BASE}/upload`, {
                    method: 'POST',
                    body: formData
                });
                const data = await res.json();
                if (data.success) {
                    resultEl.textContent = '✅ Успешно загружено!';
                    // Обновляем профиль и лидерборд
                    loadProfile();
                    loadLeaderboard();
                } else {
                    throw new Error(data.message || 'Ошибка сервера');
                }
            } catch (err) {
                console.error(err);
                resultEl.textContent = '❌ Ошибка загрузки.';
            }
        });

        // При загрузке страницы показываем профиль
        document.addEventListener('DOMContentLoaded', () => showTab('profile'));
    </script>
</body>
</html>
